<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Admin Panel</title>
  </head>

  <body>
    <div class="container">
      <!-- Header & Navigation -->
      <div class="card" style="margin-bottom: 30px">
        <div class="navbar">
          <div class="navbar-title">
            <h2>‚öΩ Football Match Signups</h2>
          </div>
          <div class="navbar-actions">
            <button id="themeBtn" onclick="toggleTheme()" class="secondary">
              üåô Dark Mode
            </button>
            <button onclick="downloadPDF()" class="secondary">üìÑ PDF</button>
            <button onclick="downloadExcel()" class="secondary">
              üìä Excel
            </button>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="card" style="margin-bottom: 20px">
        <div class="controls">
          <div class="search-box">
            <input
              type="text"
              id="searchInput"
              placeholder="üîç Search by name, email, or phone..."
              oninput="loadUsers()"
            />
          </div>

          <div class="sort-box">
            <label for="sortSelect" style="white-space: nowrap">Sort by:</label>
            <select
              id="sortSelect"
              title="Sort users by signup time"
              onchange="loadUsers()"
            >
              <option value="desc">üìÖ Newest First</option>
              <option value="asc">üìÖ Oldest First</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="card">
        <table id="usersTable">
          <tr>
            <th>Full Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Signup Time</th>
            <th>Actions</th>
          </tr>
        </table>

        <!-- Pagination -->
        <div id="pagination">
          <button id="prevBtn" onclick="changePage(-1)" class="secondary">
            ‚Üê Previous
          </button>
          <span id="pageInfo">Page 1</span>
          <button id="nextBtn" onclick="changePage(1)" class="secondary">
            Next ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- Excel Library -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
      const socket = io();
      let currentPage = 1;
      const pageSize = 10; // users per page
      let totalUsers = 0;

      // ================= LOAD USERS =================
      async function loadUsers() {
        const search = document.getElementById("searchInput").value;
        const sortOrder = document.getElementById("sortSelect").value;

        const res = await fetch(
          `/users?search=${search}&sort=${sortOrder}&page=${currentPage}&limit=${pageSize}`,
        );
        const data = await res.json();

        const users = data.users;
        totalUsers = data.total;

        const table = document.getElementById("usersTable");
        table.innerHTML = `
          <tr>
            <th>Full Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Signup Time</th>
            <th>Actions</th>
          </tr>
        `;

        users.forEach((user) => {
          const row = table.insertRow();
          row.insertCell(0).innerText = user.fullname;
          row.insertCell(1).innerText = user.email;
          row.insertCell(2).innerText = user.phone;
          row.insertCell(3).innerText = new Date(
            user.createdAt,
          ).toLocaleString();

          const actionsCell = row.insertCell(4);
          actionsCell.style.display = "flex";
          actionsCell.style.gap = "8px";
          actionsCell.style.flexWrap = "wrap";
          actionsCell.innerHTML = `
            <button onclick='editUser("${user.email}")' style="flex: 1; padding: 8px; font-size: 0.85rem;" class="secondary">‚úèÔ∏è Edit</button>
            <button onclick='deleteUser("${user.email}")' style="flex: 1; padding: 8px; font-size: 0.85rem;" class="danger">üóëÔ∏è Delete</button>
          `;
        });

        document.getElementById("pageInfo").innerText =
          `Page ${currentPage} of ${Math.ceil(totalUsers / pageSize)}`;
        document.getElementById("prevBtn").disabled = currentPage === 1;
        document.getElementById("nextBtn").disabled =
          currentPage * pageSize >= totalUsers;
      }

      function changePage(delta) {
        currentPage += delta;
        loadUsers();
      }

      // ================= DELETE =================
      async function deleteUser(email) {
        if (confirm(`Are you sure you want to delete ${email}?`)) {
          const res = await fetch("/users", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });
          loadUsers();
        }
      }

      // ================= EDIT =================
      async function editUser(email) {
        const newFullname = prompt("Enter new full name:");
        const newPhone = prompt("Enter new phone number:");

        if (!newFullname && !newPhone) return;

        const data = { email };
        if (newFullname) data.fullname = newFullname;
        if (newPhone) data.phone = newPhone;

        await fetch("/users", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        loadUsers();
      }

      // ================= LIVE UPDATES =================
      socket.on("newUser", loadUsers);
      socket.on("updateUser", loadUsers);
      socket.on("deleteUser", loadUsers);

      // ================= EXCEL DOWNLOAD =================
      function downloadExcel() {
        const table = document.getElementById("usersTable");
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.table_to_sheet(table);
        XLSX.utils.book_append_sheet(workbook, worksheet, "Signups");
        XLSX.writeFile(workbook, "FootballSignups.xlsx");
      }

      // ================= PDF DOWNLOAD =================
      function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Football Match Signups", 14, 15);
        doc.autoTable({
          html: "#usersTable",
          startY: 20,
        });
        doc.save("FootballSignups.pdf");
      }

      // ================= THEME TOGGLE =================
      function toggleTheme() {
        document.body.classList.toggle("dark");

        const isDark = document.body.classList.contains("dark");
        const themeBtn = document.getElementById("themeBtn");
        themeBtn.innerText = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";

        localStorage.setItem("theme", isDark ? "dark" : "light");
      }

      // Load saved theme
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark");
        document.getElementById("themeBtn").innerText = "‚òÄÔ∏è Light Mode";
      }

      // Initial Load
      loadUsers();
    </script>
  </body>
</html>
