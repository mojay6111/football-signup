<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="style.css" />
  <title>Admin Panel</title>
</head>

<body>

<h2>Football Match Signups</h2>

<div style="margin-bottom:10px;">
  <button onclick="downloadExcel()">Download Excel</button>
  <button onclick="downloadPDF()">Download PDF</button>
</div>xz

<table border="1" id="usersTable">
  <tr>
    <th>Full Name</th>
    <th>Email</th>
    <th>Phone</th>
    <th>Signup Time</th>
    <th>Actions</th>
  </tr>
</table>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<!-- Excel Library -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<!-- PDF Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
const socket = io();

// ================= LOAD USERS =================
async function loadUsers() {
  const res = await fetch("/users");
  const users = await res.json();

  const table = document.getElementById("usersTable");
  table.innerHTML = `
    <tr>
      <th>Full Name</th>
      <th>Email</th>
      <th>Phone</th>
      <th>Signup Time</th>
      <th>Actions</th>
    </tr>
  `;

  users.forEach(user => {
    const row = table.insertRow();

    row.insertCell(0).innerText = user.fullname;
    row.insertCell(1).innerText = user.email;
    row.insertCell(2).innerText = user.phone;
    row.insertCell(3).innerText =
      new Date(user.createdAt).toLocaleString();

    row.insertCell(4).innerHTML = `
      <button onclick="editUser('${user.email}')">Edit</button>
      <button onclick="deleteUser('${user.email}')">Delete</button>
    `;
  });
}

// ================= DELETE =================
async function deleteUser(email) {
  await fetch("/users", {
    method: "DELETE",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email })
  });
}

// ================= EDIT =================
async function editUser(email) {
  const newFullname = prompt("Enter new full name:");
  const newPhone = prompt("Enter new phone number:");

  if (!newFullname && !newPhone) return;

  const data = { email };
  if (newFullname) data.fullname = newFullname;
  if (newPhone) data.phone = newPhone;

  await fetch("/users", {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
}

// ================= LIVE UPDATES =================
socket.on("newUser", loadUsers);
socket.on("updateUser", loadUsers);
socket.on("deleteUser", loadUsers);

// ================= EXCEL DOWNLOAD =================
function downloadExcel() {
  const table = document.getElementById("usersTable");
  const workbook = XLSX.utils.book_new();
  const worksheet = XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(workbook, worksheet, "Signups");
  XLSX.writeFile(workbook, "FootballSignups.xlsx");
}

// ================= PDF DOWNLOAD =================
function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Football Match Signups", 14, 15);
  doc.autoTable({
    html: "#usersTable",
    startY: 20
  });
  doc.save("FootballSignups.pdf");
}

// Initial Load
loadUsers();
</script>

</body>
</html>
